// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  USER
  SPONSOR
  ORGANIZER
  MANAGER
  ADMIN
  SUPER_ADMIN
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum EmailStatus {
  SENT
  FAILED
}

enum NotificationSeverity {
  INFO
  SUCCESS
  WARNING
  ERROR
}

// ============================================
// TENANT MODEL (root domain entity)
// ============================================

model Tenant {
  id        String       @id @default(uuid()) @db.Uuid
  name      String       @db.VarChar(255)
  slug      String       @unique @db.VarChar(255)
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  // Relations
  users        User[]
  companies    Company[]
  organizers   Organizer[]
  events       Event[]
  sponsorships Sponsorship[]
  proposals    Proposal[]
  auditLogs    AuditLog[]
  emailLogs    EmailLog[]
  notifications Notification[]

  // Indexes
  @@index([slug])
  @@index([status])
  @@map("tenants")
}

// ============================================
// AUTH MODELS
// ============================================

model User {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  companyId   String?  @map("company_id") @db.Uuid
  organizerId String?  @map("organizer_id") @db.Uuid
  email       String   @unique
  password    String // Stored hashed (bcrypt/argon2)
  role        Role     @default(USER)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company       Company?       @relation(fields: [companyId], references: [id], onDelete: SetNull)
  organizer     Organizer?     @relation(fields: [organizerId], references: [id], onDelete: SetNull)
  refreshTokens RefreshToken[]
  notifications Notification[]

  // Indexes
  @@index([tenantId])
  @@index([email])
  @@index([companyId])
  @@index([organizerId])
  @@map("users")
}

model RefreshToken {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  tokenHash  String    @map("token_hash") // Stored hashed (sha256)
  deviceInfo String?   @map("device_info") // Optional: browser, device name
  isRevoked  Boolean   @default(false) @map("is_revoked")
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  rotatedAt  DateTime? @map("rotated_at") // Set when token is rotated

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// COMPANY MODEL
// ============================================

enum CompanyType {
  SPONSOR
  ORGANIZER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum SponsorshipStatus {
  PENDING
  ACTIVE
  PAUSED
  CANCELLED
  COMPLETED
}

enum ProposalStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  WITHDRAWN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Company {
  id                 String             @id @default(uuid()) @db.Uuid
  tenantId           String             @map("tenant_id") @db.Uuid
  name               String             @db.VarChar(255)
  slug               String?            @unique @db.VarChar(255)
  type               CompanyType
  website            String?            @db.VarChar(500)
  description        String?            @db.Text
  logoUrl            String?            @map("logo_url") @db.VarChar(500)
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  isActive           Boolean            @default(true) @map("is_active")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users        User[]
  sponsorships Sponsorship[]

  // Indexes
  @@index([tenantId])
  @@index([type])
  @@index([tenantId, type])
  @@index([verificationStatus])
  @@index([slug])
  @@map("companies")
}

// ============================================
// ORGANIZER MODEL (domain entity — manages events)
// ============================================

model Organizer {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  contactEmail String?  @map("contact_email") @db.VarChar(255)
  contactPhone String?  @map("contact_phone") @db.VarChar(50)
  website      String?  @db.VarChar(500)
  logoUrl      String?  @map("logo_url") @db.VarChar(500)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  events Event[]
  users  User[]

  // Indexes
  @@index([tenantId])
  @@index([isActive])
  @@index([tenantId, isActive])
  @@map("organizers")
}

// ============================================
// EVENT MODEL (domain entity — owned by Organizer)
// ============================================

model Event {
  id                 String             @id @default(uuid()) @db.Uuid
  tenantId           String             @map("tenant_id") @db.Uuid
  organizerId        String             @map("organizer_id") @db.Uuid
  title              String             @db.VarChar(255)
  description        String?            @db.Text
  location           String?            @db.VarChar(500)
  venue              String?            @db.VarChar(255)
  expectedFootfall   Int                @default(0) @map("expected_footfall")
  startDate          DateTime           @map("start_date")
  endDate            DateTime           @map("end_date")
  status             EventStatus        @default(DRAFT)
  website            String?            @db.VarChar(500)
  logoUrl            String?            @map("logo_url") @db.VarChar(500)
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  isActive           Boolean            @default(true) @map("is_active")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizer    Organizer     @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  sponsorships Sponsorship[]

  // Indexes
  @@index([tenantId])
  @@index([organizerId])
  @@index([status])
  @@index([tenantId, status])
  @@index([organizerId, status])
  @@index([verificationStatus])
  @@index([isActive, status, verificationStatus])
  @@map("events")
}

// ============================================
// SPONSORSHIP MODEL (Company ↔ Event link)
// ============================================

model Sponsorship {
  id          String            @id @default(uuid()) @db.Uuid
  tenantId    String            @map("tenant_id") @db.Uuid
  companyId   String            @map("company_id") @db.Uuid
  eventId     String            @map("event_id") @db.Uuid
  status      SponsorshipStatus @default(PENDING)
  tier        String?           @db.VarChar(100)
  notes       String?           @db.Text
  isActive    Boolean           @default(true) @map("is_active")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  event   Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  proposals Proposal[]

  // Unique constraint: one sponsorship per company–event pair
  @@unique([companyId, eventId])

  // Indexes
  @@index([tenantId])
  @@index([companyId])
  @@index([eventId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, isActive])
  @@map("sponsorships")
}

// ============================================
// PROPOSAL MODEL (workflow entity — negotiation / approval)
// ============================================

model Proposal {
  id             String         @id @default(uuid()) @db.Uuid
  tenantId       String         @map("tenant_id") @db.Uuid
  sponsorshipId  String         @map("sponsorship_id") @db.Uuid
  status         ProposalStatus @default(DRAFT)
  proposedTier   String?        @map("proposed_tier") @db.VarChar(100)
  proposedAmount Decimal?       @map("proposed_amount") @db.Decimal(12, 2)
  message        String?        @db.Text
  notes          String?        @db.Text
  submittedAt    DateTime?      @map("submitted_at")
  reviewedAt     DateTime?      @map("reviewed_at")
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sponsorship Sponsorship @relation(fields: [sponsorshipId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId])
  @@index([sponsorshipId])
  @@index([status])
  @@index([tenantId, status])
  @@index([sponsorshipId, status])
  @@map("proposals")
}

// ============================================
// AUDIT LOG MODEL (append-only system log)
// ============================================

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid

  // Who performed the action
  actorId   String   @map("actor_id") @db.Uuid
  actorRole String   @map("actor_role") @db.VarChar(50)

  // What happened
  action    String   @db.VarChar(100) // e.g. "proposal.created", "proposal.status_changed"

  // Which entity was affected
  entityType String  @map("entity_type") @db.VarChar(50)  // e.g. "Proposal", "Sponsorship"
  entityId   String  @map("entity_id") @db.Uuid

  // Arbitrary JSON payload (old/new values, context, etc.)
  metadata  Json?    @default("{}") @db.JsonB

  // Immutable timestamp
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Indexes for efficient querying
  @@index([tenantId])
  @@index([actorId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([tenantId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// EMAIL LOG MODEL (delivery tracking)
// ============================================

model EmailLog {
  id           String      @id @default(uuid()) @db.Uuid
  tenantId     String      @map("tenant_id") @db.Uuid
  recipient    String      @db.VarChar(255)
  subject      String      @db.VarChar(500)
  jobName      String      @map("job_name") @db.VarChar(100)
  entityType   String?     @map("entity_type") @db.VarChar(50)
  entityId     String?     @map("entity_id") @db.Uuid
  status       EmailStatus
  errorMessage String?     @map("error_message") @db.Text
  createdAt    DateTime    @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId])
  @@index([jobName])
  @@index([status])
  @@index([tenantId, createdAt])
  @@map("email_logs")
}

// ============================================
// NOTIFICATION MODEL
// ============================================

model Notification {
  id         String               @id @default(uuid()) @db.Uuid
  tenantId   String               @map("tenant_id") @db.Uuid
  userId     String               @map("user_id") @db.Uuid
  title      String               @db.VarChar(255)
  message    String               @db.Text
  severity   NotificationSeverity @default(INFO)
  read       Boolean              @default(false)
  link       String?              @db.VarChar(512)
  entityType String?              @map("entity_type") @db.VarChar(50)
  entityId   String?              @map("entity_id") @db.Uuid
  createdAt  DateTime             @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([tenantId])
  @@index([userId])
  @@index([userId, read])
  @@index([tenantId, createdAt])
  @@map("notifications")
}
